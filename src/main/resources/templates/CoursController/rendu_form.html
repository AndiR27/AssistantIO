<!--
  rendu_form.html

  @param coursId java.lang.Long
  @param tp org.acme.models.TravailPratiqueDTO (ou selon tes classes)
  @param renduExiste java.lang.Boolean

  On suppose que tp.rendu peut contenir:
   - id
   - cheminVersStructure
   - etc.
-->
<style>
    .zip-status {
        padding: 0.4rem;
        margin: 0.3rem 0;
        border-radius: 4px;
        color: #fff;
        font-weight: bold;
    }

    .zip-status-empty {
        background-color: #ddd;
        color: #000;
    }

    .zip-status-pending {
        background-color: orange;
    }

    .zip-status-ready {
        background-color: green;
    }

    .btn {
        padding: 0.3rem 0.6rem;
        border: none;
        cursor: pointer;
        color: #fff;
        margin: 0.3rem 0;
    }

    .btn-upload {
        background-color: #007bff;
    }

    .btn-process {
        background-color: #6c757d;
        margin-left: 0rem;
    }

    .btn-plus {
        background-color: #28a745;
        font-size: 1rem;
        font-weight: bold;
        margin-left: 0.5rem;
    }

    /* Wrapper pour positionner la bulle */
    .rendu-bubble-wrapper {
        position: relative;
        display: inline-block;
    }

    /* La bulle au-dessus, centr√©e horizontalement, cach√©e par d√©faut */
    .upload-form-bubble {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 999;
        background-color: #fff;
        border: 1px solid #ccc;
        padding: 0.8rem 1rem;
        border-radius: 4px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
        text-align: center;
        width: 240px; /* Ajuste la largeur selon ton besoin */
        display: none; /* cach√© par d√©faut */
    }

    /* Fl√®che triangulaire */
    .upload-form-bubble::after {
        content: "";
        position: absolute;
        bottom: -8px;
        left: 50%;
        transform: translateX(-50%);
        border-left: 8px solid transparent;
        border-right: 8px solid transparent;
        border-top: 8px solid #ccc;
    }

    /* Bouton X en haut √† droite */
    .bubble-close-btn {
        position: absolute;
        top: 5px;
        right: 5px;
        background: transparent;
        border: none;
        font-size: 1.2rem;
        cursor: pointer;
    }

    .bubble-error {
        color: red;
        font-weight: bold;
        margin: 0.5rem 0;
    }
</style>

<!-- Conteneur unique par TP -->
<div id="rendu-zip-container-{tp.no}">

    {#if tp.rendu == null}
    <!-- √âTAT 1) AUCUN RENDU -->
    <!--
      Bouton + qui d√©voile la "bulle"
      On l'enrobe dans .rendu-bubble-wrapper
    -->
    <!-- Bouton + pour afficher la bulle d'upload -->
    <div class="rendu-bubble-wrapper">
        <button
                type="button"
                class="btn btn-plus"
                onclick="toggleUploadBubble_{tp.no}()"
                title="Ajouter un rendu ZIP"
        >
            +
        </button>

        <!-- Bulle -->
        <div
                id="upload-bubble-{tp.no}"
                class="upload-form-bubble">
        <!-- Si error != null => on la laisse ouverte -->

        <!-- Bouton X pour fermer la bulle -->
        <button class="bubble-close-btn" type="button" onclick="toggleUploadBubble_{tp.no}(true)">√ó</button>

        <p><strong>Ajouter un Rendu ZIP</strong></p>
        <form
                style="margin-top:0.5rem;"
                hx-post="/cours/{coursId}/TP/{tp.no}/addRenduZip"
                hx-target="#rendu-zip-container-{tp.no}"
                hx-swap="outerHTML"
                enctype="multipart/form-data"
                method="post"
        >
            <input
                    type="file"
                    name="file"
                    accept=".zip"
                    required
                    style="margin-bottom: 0.5rem;"
            /><br/>
            <button type="submit" class="btn btn-upload">
                üì• Uploader
            </button>
        </form>
    </div>
</div>

<script>
    function toggleUploadBubble_{tp.no}(forceClose) {
        const bubble = document.getElementById('upload-bubble-{tp.no}');

        // Si forceClose == true, on ferme forc√©ment
        if (forceClose) {
            bubble.style.display = 'none';
            return;
        }

        // Sinon, on toggle
        bubble.style.display = (bubble.style.display === 'none' || bubble.style.display === '')
            ? 'block'
            : 'none';
    }
</script>
{#else}
    <!-- CAS 2) Rendu pr√©sent => check si "tp.rendu.cheminVersStructure" est d√©fini -->
    {#if tp.rendu.cheminFichierStructure == null}
        <!-- Rendu non trait√©, affichage orange -->
        <!-- Bouton pour lancer le traitement (futur endpoint) -->
        <button
                class="btn btn-process"
                hx-put="/cours/{coursId}/TP/{tp.no}/traitementZip"
                hx-target="#rendu-zip-container-{tp.no}"
                hx-swap="outerHTML"
                hx-on="htmx:afterRequest: window.location.reload()"
                type="button"
        >Traiter le ZIP
        </button>
    {#else}
        <!-- CAS 3) Rendu trait√© => affichage vert -->
        <!-- Lien pour t√©l√©charger le fichier trait√© -->
        <a
                class="btn btn-upload"
                href="/cours/{coursId}/TP/{tp.no}/downloadZip/{tp.rendu.id}"
                target="_blank"
                title="T√©l√©charger le rendu trait√©"
        >
            T√©l√©charger
        </a>
    {/if}
{/if}

</div>
