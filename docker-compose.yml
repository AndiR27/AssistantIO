version: "3.9"

services:
  backend:
    build:
      context: ./BackendSpring
      dockerfile: src/main/docker/Dockerfile.jvm
      target: runtime
    image: zackrey27/assistantio-backend
    container_name: assistantio_backend
    environment:
      # ==========================
      # HTTP / Port
      # ==========================
      HTTP_PORT: "8088"

      # ==========================
      # Base de données (EXTERNE, stack Postgres déjà sur le NAS)
      # ==========================
      SPRING_DATASOURCE_URL: ${SPRING_DATASOURCE_URL}
      SPRING_DATASOURCE_USERNAME: ${SPRING_DATASOURCE_USERNAME}
      SPRING_DATASOURCE_PASSWORD: ${SPRING_DATASOURCE_PASSWORD}

      # ==========================
      # JPA / Hibernate / Flyway
      # ==========================
      SPRING_JPA_DDL_AUTO: update
      SPRING_FLYWAY_ENABLED: "false"

      # ==========================
      # Logs
      # ==========================
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      TOMCAT_ACCESS_LOG_ENABLED: "false"

      # ==========================
      # CORS (front Angular dans ce même stack)
      # ==========================
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS:-http://localhost:4200}

      # ==========================
      # ZIP storage (volume NAS)
      # ==========================
      ZIP_STORAGE_PATH: /opt/app/data/zips

    depends_on: []
    ports:
      - "${HTTP_PORT:-8088}:8088"
    restart: unless-stopped
    networks:
      - app-network
      - db-network
    volumes:
      - /volume1/docker/assistantio/data:/opt/app/data

  frontend:
    build:
      context: ./Frontend
      dockerfile: Dockerfile
    image: zackrey27/assistantio-frontend
    container_name: assistantio_frontend
    depends_on:
      - backend
    ports:
      - "4200:80"
    restart: unless-stopped
    networks:
      - app-network

networks:
  app-network:
  db-network:
    external: true
    name: postgresql_default
